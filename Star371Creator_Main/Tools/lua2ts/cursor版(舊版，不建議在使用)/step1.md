## Step 1 — 轉換規則與禁則

### 前提
- 開始 Lua 到 TypeScript 的轉換工作
- 需要嚴格遵守轉換規則，確保功能等效

### 目標
- 保持邏輯與功能完全等效，禁止任何未授權的變更
- 僅進行必要的語法轉換，不進行優化或重構
- 確保轉換後的代碼與原始代碼功能一致

### 核心轉換規則

#### 1. 總覽、目標與後果

**規則ID**: DEF_000
**類型**: 階段限制
**描述**: Step 1 階段限制：在 Step 1 階段，AI 不得對任何檔案進行內容修改或語法轉換。
**AI_操作**: AI 在 Step 1 階段只能進行規則理解、文件複製和更名操作（如 PRE_EXEC_001 所述），不得執行任何程式碼轉換、語法替換或內容修改。所有實際的轉換工作必須等到 Step 2 及後續階段才能進行。

**規則ID**: DEF_001
**類型**: 定義
**描述**: 本規則僅用於 Lua → TypeScript 語法轉換。
**AI_操作**: AI 應將此規則集應用於 Lua 程式碼到 TypeScript 程式碼的轉換任務。

**規則ID**: DEF_002
**類型**: 目標
**描述**: 轉換目標：保持邏輯與功能完全等效，禁止任何未授權的變更。
**AI_操作**: AI 的所有轉換行為都應以實現源代碼的功能等效為最終目標，並嚴格遵守所有禁止行為和通用原則。

#### 2. 核心禁令 (Core)

- **規則ID**: CORE_001
  **類型**: 禁止行為
  **描述**: 不得創造新實體（變數、函數、類、常數）。
  **AI_操作**: 在轉換過程中，AI 不得引入任何源代碼中不存在的新實體（變數、函數、類、常數等）。轉換完成後，AI 應驗證目標代碼中沒有新增實體。

- **規則ID**: CORE_002
  **類型**: 禁止行為
  **描述**: 不得省略任何邏輯或定義。
  **AI_操作**: AI 必須確保源代碼中的所有邏輯流程、變數定義、函數定義等都完整地轉換到目標代碼中，不得有任何遺漏。轉換完成後，AI 應驗證目標代碼的邏輯完整性。

- **規則ID**: CORE_003
  **類型**: 禁止行為
  **描述**: 不得做任何「優化/重構/改進」，除非是必要語法轉換。
  **AI_操作**: AI 不得對源代碼進行任何形式的自動優化、重構或改進，除非這些操作是為了實現語法轉換的必要步驟，且不改變原有邏輯和行為。此規則僅在實際轉換階段（Step 2 及之後）適用。

#### 3. 等價性不變量 (Equivalence Invariants)

- **規則ID**: EQUIV_001
  **類型**: 通用原則
  **描述**: 邏輯流程不變：保持控制流程、條件、循環等完全一致。
  **AI_操作**: AI 必須確保轉換後的代碼在執行順序、條件判斷、循環結構等方面與源代碼的邏輯結構完全一致。

- **規則ID**: EQUIV_002
  **類型**: 通用原則
  **描述**: 命名不變：保留所有變數與函數名稱，除非規則要求。
  **AI_操作**: AI 應保留源代碼中的變數命名風格和具體名稱，除非其他規則明確要求進行命名調整。

- **規則ID**: EQUIV_003
  **類型**: 通用原則
  **描述**: 參數不變：保持函數參數順序與數量。
  **AI_操作**: AI 在轉換函數定義和調用時，必須確保參數的順序和數量與源代碼完全一致。

#### 4. 註解不變 (Comments Invariance)

- **規則ID**: COMMENT_001
  **類型**: 通用原則
  **描述**: 保持註解完整，不得刪除、修改或新增。
  **AI_操作**: AI 不得刪除、修改或新增源代碼中的原有註解。

#### 5. 一對一轉換 (One-to-One Conversion)

- **規則ID**: CONVERSION_001
  **類型**: 轉換原則
  **描述**: 參數形式必須完全一致（字面量、變數引用、常數名）。
  **AI_操作**: AI 在轉換函數調用或屬性賦值時，必須確保參數的數量、順序和表達形式（字面量、變數引用、常數名稱等）與源代碼完全匹配。

- **規則ID**: CONVERSION_002
  **類型**: 錯誤模式
  **描述**: 嚴禁替換或改寫參數表達式。
  **AI_操作**: AI 應識別並避免參數形式修改，保持原始表達式不變。

#### 6. 常數處理 (Constants)

- **規則ID**: CONSTANT_001
  **類型**: 常數處理
  **描述**: 在 TS 中保留原常數名稱。
  **AI_操作**: AI 應識別 Lua 中的常數，並在 TypeScript 中使用相同的名稱。

- **規則ID**: CONSTANT_002
  **類型**: 常數處理
  **描述**: 若 TS 環境無定義，禁止新增定義，允許編譯器報錯。
  **AI_操作**: AI 不得為未定義的常數自動生成定義。如果遇到未定義的常數，AI 應將其保留，並預期編譯器會報告錯誤，以便後續人工處理。

#### 7. 禁止模式 (Forbidden Patterns)

- **規則ID**: FORBID_001
  **類型**: 錯誤模式
  **描述**: 不得新增功能或空值檢查（除非原碼已有）。
  **AI_操作**: AI 不得在轉換過程中引入任何源代碼中不存在的功能，也不得自動添加空值檢查或防禦性程式碼，除非源代碼中已明確存在。

- **規則ID**: FORBID_002
  **類型**: 錯誤模式
  **描述**: 不得修改常數值。
  **AI_操作**: AI 不得修改源代碼中常數的數值。

- **規則ID**: FORBID_003
  **類型**: 錯誤模式
  **描述**: 禁止將所有變數一律改為同一類型。
  **AI_操作**: 必須根據變數的實際使用情況選擇適當的類型。

#### 8. 轉換流程 (Process)

- **規則ID**: PROCESS_001
  **類型**: 流程步驟
  **描述**: 理解原碼：先分析 Lua 功能。
  **AI_操作**: AI 在進行轉換前，應對源代碼進行全面分析，理解其功能和上下文。

- **規則ID**: PROCESS_002
  **類型**: 流程步驟
  **描述**: 語法替換：僅做必要 API 對應。
  **AI_操作**: AI 應根據預設的 Lua-TypeScript API 對應關係進行語法轉換。

- **規則ID**: PROCESS_003
  **類型**: 流程步驟
  **描述**: 參數保持：參數數量、順序、形式不可變。
  **AI_操作**: AI 必須嚴格遵守 CONVERSION_001 規則。

- **規則ID**: PROCESS_004
  **類型**: 流程步驟
  **描述**: 保留編譯錯誤：對於未定義常數/類/函數，保留原樣，由 TS 編譯器報錯。
  **AI_操作**: AI 不應嘗試「修復」所有潛在的編譯錯誤。對於無法直接轉換或需要人工判斷的部分，AI 應保留其原始形式或轉換為最接近的語法，並預期 TypeScript 編譯器會報告錯誤。

- **規則ID**: PROCESS_005
  **類型**: 流程步驟
  **描述**: 檢查一致性：驗證轉換後程式碼邏輯與原始碼完全一致。
  **AI_操作**: 轉換完成後，AI 應進行內部驗證，確保目標代碼在功能和邏輯上與源代碼等效。

#### 9. 目標與後果 (Outcomes)

- **規則ID**: OUTCOME_001
  **類型**: 後果
  **描述**: 違規將導致程式不一致、維護困難、團隊協作受阻。
  **AI_操作**: AI 應將此作為高優先級的約束，避免產生違反規則的輸出。

#### 10. 規則使用指南

**規則ID**: PRIORITY_001
**類型**: 元規則
**描述**: 若規則衝突，優先序如下：
  `Core` > `Equivalence Invariants` > `Conversion/Constants` > `Forbidden Patterns` > `Process`
**AI_操作**: 當多條規則可能產生衝突時，AI 應嚴格按照此優先級順序來決定執行哪條規則。高優先級的規則應覆蓋低優先級的規則。

**規則ID**: PRIORITY_002
**類型**: 元規則
**描述**: 準則：寧可編譯錯，不可改變邏輯。
**AI_操作**: AI 在轉換過程中，應優先保證邏輯的等效性，即使這可能導致編譯錯誤。編譯錯誤應留待後續人工處理。

**規則ID**: PRE_EXEC_001
**類型**: 元規則
**描述**: 下一步前置作業：
1) 將原始檔使用指令複製一份（禁止手動寫入或創建新檔案），
2) 並將副檔名改為 `.ts`（僅更名，不改動內容），
3) 完成後再進入 step2.md 進行語法轉換。
**AI_操作**: 僅在上述複製與更名完成後，才開始執行 step2.md 的轉換規則。禁止使用 write 工具創建新檔案，必須使用 cp 或 copy 指令複製。

### 注意事項
- 嚴格遵守所有核心禁令，不得違反任何規則
- 保持功能等效性，不進行任何優化或重構
- 寧可編譯錯，不可改變邏輯
- **重要**：Step 1 階段不得進行任何實際的語法轉換

### 完成檢查清單
- 已理解所有轉換規則和禁則
- 已確認轉換目標：功能等效性
- 已了解優先級順序：Core > Equivalence Invariants > Conversion/Constants > Forbidden Patterns > Process
- 已準備好進行下一步轉換

### 下一步
- 請進行 step2.md：類別結構與生命週期轉換